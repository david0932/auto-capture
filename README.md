# Auto Page Capture - Chrome 擴充功能

自動翻頁截圖工具，支援自動裁切空白、合併 PDF 等功能。

## 功能特色

### ✅ 核心功能

1. **自動翻頁擷取**
   - 自動模擬鍵盤或滑鼠操作翻頁
   - 支援 iframe 內的電子書閱讀器
   - 智慧偵測翻頁失敗並自動停止

2. **靈活的頁數設定**
   - 指定擷取頁數（例如：10 頁）
   - 擷取到最後（自動偵測無法翻頁時停止）
   - 手動停止功能

3. **自動裁切空白**
   - 智慧識別並移除圖片左右空白區域
   - 使用採樣演算法提高效率
   - 可調整的閾值參數（WHITE_THRESHOLD = 240）
   - 保留 5px 邊距避免裁切過緊

4. **合併成 PDF**
   - 可選擇將所有圖片合併成單一 PDF 檔案
   - 橫式（landscape）A4 排版
   - 保持圖片原始比例，自動居中
   - 不會失真或變形

5. **時間戳記資料夾**
   - 每次擷取自動建立帶時間戳記的資料夾
   - 格式：`auto-capture-YYYY-MM-DDTHH-MM-SS`
   - 避免檔案覆蓋，方便管理

6. **自動儲存**
   - 不彈出儲存對話框
   - 直接下載到預設下載資料夾
   - 支援檔名衝突自動重命名

## 使用方式

### 安裝

1. 前往 `chrome://extensions/`
2. 開啟「開發人員模式」
3. 點擊「載入未封裝項目」
4. 選擇 `auto-capture` 資料夾

### 設定瀏覽器（重要）

為了避免下載時彈出對話框，需要設定：

1. 開啟 Chrome 設定：`chrome://settings/downloads`
2. **關閉**「下載前先詢問每個檔案的儲存位置」

### 使用步驟

1. 開啟要擷取的電子書或網頁
2. 點擊擴充功能圖示開啟控制面板
3. 設定選項：
   - **要擷取的頁數**：輸入數字（例如：10）
   - **擷取到最後**：勾選後會自動擷取到無法翻頁為止
   - **完成後合併成 PDF 檔案**：勾選後會生成 PDF
4. 點擊「開始」按鈕
5. 等待擷取完成（可隨時點擊「停止」中斷）

## 檔案結構

```
下載資料夾/
├── auto-capture-2025-12-12T10-30-45/
│   ├── page-001.png  (已裁切空白)
│   ├── page-002.png  (已裁切空白)
│   ├── page-003.png  (已裁切空白)
│   └── merged.pdf    (橫式，保持比例)
├── auto-capture-2025-12-12T11-15-20/
│   ├── page-001.png
│   ├── page-002.png
│   └── merged.pdf
└── auto-capture-2025-12-12T14-22-10/
    ├── page-001.png
    ├── page-002.png
    └── page-003.png
```

## 技術細節

### 檔案說明

- `manifest.json` - 擴充功能設定檔
- `background.js` - 背景服務，處理截圖、下載、PDF 生成
- `content.js` - 內容腳本，處理自動翻頁邏輯
- `popup.html` - 控制面板介面
- `popup.js` - 控制面板邏輯
- `jspdf.umd.min.js` - PDF 生成庫

### 裁切演算法

```javascript
// 參數設定
WHITE_THRESHOLD = 240       // RGB 閾值，低於此值視為內容
SAMPLE_STEP = 10            // 採樣間隔（像素）
CONTENT_THRESHOLD = 0.05    // 內容密度閾值（5%）
PADDING = 5                 // 裁切後保留的邊距（像素）

// 判斷邏輯
1. 垂直方向只檢查中間 80% 區域（避免邊緣噪點）
2. 每隔 10 像素採樣一次（提高效率）
3. 計算每列的內容像素比例
4. 超過 5% 視為有內容的列
5. 找到左右邊界後各保留 5px 邊距
```

### PDF 生成

```javascript
// 比例計算
1. 取得圖片原始尺寸（寬 x 高）
2. 計算圖片比例 = imgWidth / imgHeight
3. 計算頁面比例 = pageWidth / pageHeight
4. 根據比例選擇縮放方式：
   - 圖片較寬 → 以寬度為基準，垂直置中
   - 圖片較高 → 以高度為基準，水平置中
5. 保持原始比例，不拉伸變形
```

## 翻頁機制

### 自動翻頁方式

1. **鍵盤事件**：模擬按下右方向鍵（ArrowRight）
2. **滑鼠點擊**：點擊畫面右側 85% 位置

### 翻頁成功判斷

- 檢測 HTML 內容是否改變
- 連續 3 次翻頁失敗則判定為最後一頁
- 自動發送停止訊息

### 執行流程

```
開始
 ↓
擷取第一頁（當前頁面）
 ↓
等待 1 秒
 ↓
嘗試翻頁 → 成功 → 擷取該頁 → 繼續
     ↓
    失敗
     ↓
   計數 +1
     ↓
  達到 3 次？
     ↓
    是 → 停止並生成 PDF
     ↓
    否 → 繼續嘗試
```

## 常見問題

### Q: 為什麼下載時會彈出對話框？

A: 請確認已關閉 Chrome 的「下載前先詢問每個檔案的儲存位置」設定。

### Q: 如何調整裁切的敏感度？

A: 在 `background.js` 中修改 `WHITE_THRESHOLD` 參數：
- 降低數值（如 230）→ 更積極裁切
- 提高數值（如 250）→ 更保守裁切

### Q: PDF 中的圖片還是有空白？

A: 裁切功能只移除左右空白。如需移除上下空白，可以修改 `cropImageWhitespace` 函數增加垂直方向的裁切。

### Q: 為什麼沒有擷取到第一頁？

A: 已修正！現在會在翻頁前先擷取當前頁面。

### Q: 如何只下載圖片不生成 PDF？

A: 不要勾選「完成後合併成 PDF 檔案」選項即可。

## 版本歷史

### v1.3 (2025-12-12)
- ✨ 新增：合併成 PDF 功能
- ✨ 新增：自動裁切左右空白
- ✨ 新增：時間戳記資料夾
- ✨ 新增：擷取到最後功能
- 🐛 修正：PDF 圖片比例失真問題
- 🐛 修正：Service Worker 載入錯誤
- 🐛 修正：漏掉第一頁的問題
- 📝 改進：PDF 使用橫式排版

### v1.2
- ✨ 新增：可設定擷取頁數
- ✨ 新增：自動儲存不彈出對話框

### v1.0
- 🎉 初始版本
- ✨ 基本自動翻頁擷取功能

## 授權

本專案僅供學習和個人使用。

## 貢獻

歡迎提出問題和改進建議。
